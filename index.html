<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PartexChat</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Arial', sans-serif;
    }

    body {
      background: linear-gradient(135deg, #0e0e0e, #1a1a1a);
      color: white;
      height: 100vh;
    }

    /* Login/Register Screen */
    #authSection {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: linear-gradient(135deg, #0e0e0e, #2d2d2d);
    }

    .auth-container {
      background: #1a1a1a;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      width: 100%;
      max-width: 400px;
      border: 1px solid #333;
    }

    .auth-container h2 {
      text-align: center;
      margin-bottom: 30px;
      color: #2ecc71;
      font-size: 28px;
    }

    .auth-input {
      width: 100%;
      padding: 15px;
      margin: 10px 0;
      background: #222;
      border: 1px solid #333;
      border-radius: 8px;
      color: white;
      font-size: 16px;
    }

    .auth-input:focus {
      border-color: #2ecc71;
      outline: none;
    }

    .auth-button {
      width: 100%;
      padding: 15px;
      background: #2ecc71;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin: 20px 0 10px;
      transition: background 0.3s;
    }

    .auth-button:hover {
      background: #27ae60;
    }

    .auth-toggle {
      text-align: center;
      margin-top: 20px;
    }

    .auth-toggle a {
      color: #2ecc71;
      text-decoration: none;
      cursor: pointer;
    }

    .auth-toggle a:hover {
      text-decoration: underline;
    }

    .error-message {
      color: #e74c3c;
      text-align: center;
      margin: 10px 0;
      padding: 10px;
      background: rgba(231, 76, 60, 0.1);
      border-radius: 5px;
      display: none;
    }

    /* Main App */
    #mainApp {
      display: none;
      height: 100vh;
      flex-direction: column;
    }

    header {
      background: #111;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid #2ecc71;
    }

    header h1 {
      color: #2ecc71;
      font-size: 24px;
    }

    .user-menu {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .user-email {
      color: #ccc;
      font-size: 14px;
    }

    .nav-button {
      background: #2ecc71;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }

    .nav-button:hover {
      background: #27ae60;
    }

    .main-content {
      display: flex;
      flex: 1;
      height: calc(100vh - 70px);
    }

    /* Servers Sidebar */
    .servers-sidebar {
      width: 80px;
      background: #151515;
      border-right: 1px solid #333;
      padding: 15px 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .server-icon {
      width: 50px;
      height: 50px;
      background: #2ecc71;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-weight: bold;
      font-size: 18px;
      transition: all 0.3s;
      border: 2px solid transparent;
    }

    .server-icon:hover {
      transform: scale(1.1);
      border-color: #2ecc71;
    }

    .server-icon.active {
      border-color: #2ecc71;
      transform: scale(1.1);
    }

    .add-server {
      background: #333;
      color: #2ecc71;
      font-size: 24px;
    }

    /* Channels Sidebar */
    .channels-sidebar {
      width: 250px;
      background: #1a1a1a;
      border-right: 1px solid #333;
      padding: 20px;
    }

    .server-header {
      color: #2ecc71;
      font-size: 18px;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #333;
    }

    .channels-list {
      list-style: none;
      margin-bottom: 20px;
    }

    .channel-item {
      padding: 10px 15px;
      margin: 5px 0;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
      color: #ccc;
    }

    .channel-item:hover {
      background: #222;
      color: white;
    }

    .channel-item.active {
      background: #2ecc71;
      color: white;
    }

    .create-channel-btn {
      width: 100%;
      padding: 10px;
      background: #333;
      color: #2ecc71;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
    }

    .create-channel-btn:hover {
      background: #444;
    }

    /* Chat Area */
    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #1a1a1a;
    }

    .chat-header {
      background: #151515;
      padding: 15px 20px;
      border-bottom: 1px solid #333;
      color: #2ecc71;
      font-size: 18px;
    }

    .messages-container {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: #151515;
    }

    .message {
      margin: 15px 0;
      padding: 10px;
      background: #222;
      border-radius: 8px;
      border-left: 3px solid #2ecc71;
    }

    .message .sender {
      color: #2ecc71;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .message .timestamp {
      color: #888;
      font-size: 12px;
      margin-left: 10px;
    }

    .message-input-container {
      padding: 20px;
      background: #151515;
      border-top: 1px solid #333;
    }

    .message-input-wrapper {
      display: flex;
      gap: 10px;
    }

    #messageInput {
      flex: 1;
      padding: 12px;
      background: #222;
      border: 1px solid #333;
      border-radius: 8px;
      color: white;
      font-size: 14px;
    }

    #messageInput:focus {
      border-color: #2ecc71;
      outline: none;
    }

    .send-button {
      padding: 12px 20px;
      background: #2ecc71;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }

    .send-button:hover {
      background: #27ae60;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: #1a1a1a;
      padding: 30px;
      border-radius: 15px;
      width: 90%;
      max-width: 400px;
      border: 1px solid #333;
    }

    .modal h3 {
      color: #2ecc71;
      margin-bottom: 20px;
      text-align: center;
    }

    .modal-input {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      background: #222;
      border: 1px solid #333;
      border-radius: 8px;
      color: white;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .modal-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }

    .modal-btn.primary {
      background: #2ecc71;
      color: white;
    }

    .modal-btn.secondary {
      background: #333;
      color: white;
    }
  </style>
</head>
<body>

  <!-- Login/Register Screen -->
  <div id="authSection">
    <div class="auth-container">
      <div id="loginDiv">
        <h2>Login zu PartexChat</h2>
        <div id="loginError" class="error-message"></div>
        <input type="email" id="loginEmail" class="auth-input" placeholder="Deine Email">
        <input type="password" id="loginPassword" class="auth-input" placeholder="Dein Passwort">
        <button class="auth-button" onclick="login()">Jetzt Einloggen</button>
        <div class="auth-toggle">
          <p>Noch keinen Account? <a onclick="toggleAuth()">Hier registrieren</a></p>
        </div>
      </div>

      <div id="registerDiv" style="display:none;">
        <h2>Account erstellen</h2>
        <div id="registerError" class="error-message"></div>
        <input type="email" id="registerEmail" class="auth-input" placeholder="Email">
        <input type="password" id="registerPassword" class="auth-input" placeholder="Passwort">
        <button class="auth-button" onclick="register()">Account erstellen</button>
        <div class="auth-toggle">
          <p>Bereits Account? <a onclick="toggleAuth()">Zum Login</a></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div id="mainApp">
    <header>
      <h1>PartexChat</h1>
      <div class="user-menu">
        <span class="user-email" id="userEmail">user@example.com</span>
        <button class="nav-button" onclick="showSettings()">Einstellungen</button>
      </div>
    </header>

    <div class="main-content">
      <!-- Servers Sidebar -->
      <div class="servers-sidebar" id="serversSidebar">
        <div class="server-icon active" onclick="selectServer('global')">üåç</div>
        <div class="server-icon add-server" onclick="showCreateServerModal()">+</div>
        <!-- Servers will be added here dynamically -->
      </div>

      <!-- Channels Sidebar -->
      <div class="channels-sidebar" id="channelsSidebar">
        <div class="server-header" id="serverName">Global Server</div>
        <ul class="channels-list" id="channelsList">
          <li class="channel-item active" onclick="selectChannel('general')"># üí¨ Allgemein</li>
          <li class="channel-item" onclick="selectChannel('games')"># üéÆ Gaming</li>
          <li class="channel-item" onclick="selectChannel('music')"># üéµ Musik</li>
        </ul>
        <button class="create-channel-btn" onclick="showCreateChannelModal()">+ Channel erstellen</button>
      </div>

      <!-- Chat Area -->
      <div class="chat-area">
        <div class="chat-header" id="chatHeader">
          # üí¨ Allgemein
        </div>
        <div class="messages-container" id="messagesContainer">
          <!-- Messages will appear here -->
        </div>
        <div class="message-input-container">
          <div class="message-input-wrapper">
            <input type="text" id="messageInput" placeholder="Schreibe eine Nachricht in #allgemein..." onkeypress="handleKeyPress(event)">
            <button class="send-button" onclick="sendMessage()">Senden</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Server Modal -->
  <div class="modal" id="createServerModal">
    <div class="modal-content">
      <h3>üöÄ Server erstellen</h3>
      <input type="text" id="serverNameInput" class="modal-input" placeholder="Server Name">
      <div class="modal-buttons">
        <button class="modal-btn secondary" onclick="hideCreateServerModal()">Abbrechen</button>
        <button class="modal-btn primary" onclick="createServer()">Erstellen</button>
      </div>
    </div>
  </div>

  <!-- Create Channel Modal -->
  <div class="modal" id="createChannelModal">
    <div class="modal-content">
      <h3>üîä Channel erstellen</h3>
      <input type="text" id="channelNameInput" class="modal-input" placeholder="Channel Name">
      <div class="modal-buttons">
        <button class="modal-btn secondary" onclick="hideCreateChannelModal()">Abbrechen</button>
        <button class="modal-btn primary" onclick="createChannel()">Erstellen</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal" id="settingsModal">
    <div class="modal-content">
      <h3>‚öôÔ∏è Einstellungen</h3>
      <p>Eingeloggt als: <strong id="settingsUserEmail">user@example.com</strong></p>
      <div class="modal-buttons">
        <button class="modal-btn secondary" onclick="hideSettingsModal()">Schlie√üen</button>
        <button class="modal-btn primary" onclick="logout()" style="background: #e74c3c;">üö™ Ausloggen</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, push, onChildAdded, set, onValue, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBWxwGrVmF2IQEGIyEZCtwp9vsRdpGAnRs",
      authDomain: "partexchat.firebaseapp.com",
      databaseURL: "https://partexchat-default-rtdb.firebaseio.com",
      projectId: "partexchat",
      storageBucket: "partexchat.firebasestorage.app",
      messagingSenderId: "348087049579",
      appId: "1:348087049579:web:a61c4aef9e7272505d802e",
      measurementId: "G-KY5XWKYY0D"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // Global Variables
    let currentServer = 'global';
    let currentChannel = 'general';
    let servers = {};

    console.log("Firebase initialized");

    // Auth Toggle
    window.toggleAuth = function() {
      const loginDiv = document.getElementById('loginDiv');
      const registerDiv = document.getElementById('registerDiv');
      loginDiv.style.display = loginDiv.style.display === 'none' ? 'block' : 'none';
      registerDiv.style.display = registerDiv.style.display === 'none' ? 'block' : 'none';
      document.getElementById('loginError').style.display = 'none';
      document.getElementById('registerError').style.display = 'none';
    }

    // Show Error
    function showError(type, message) {
      const errorDiv = document.getElementById(type + 'Error');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
    }

    // Register
    window.register = async function() {
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      
      if (!email || !password) {
        showError('register', "Bro, vergiss nicht Email und Passwort! üö®");
        return;
      }

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        console.log("User registered:", userCredential.user);
        
        // User in Database speichern
        const userRef = ref(db, 'users/' + userCredential.user.uid);
        await set(userRef, {
          email: email,
          createdAt: new Date().toISOString()
        });
        
        alert("Geil! Account erstellt! üéâ");
      } catch (error) {
        console.error("Registration error:", error);
        showError('register', "Fehler: " + error.message);
      }
    }

    // Login
    window.login = async function() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      
      if (!email || !password) {
        showError('login', "Bro, Email und Passwort nicht vergessen! üö®");
        return;
      }

      try {
        await signInWithEmailAndPassword(auth, email, password);
        console.log("Login successful");
      } catch (error) {
        console.error("Login error:", error);
        showError('login', "Login fehlgeschlagen: " + error.message);
      }
    }

    // Logout
    window.logout = function() {
      signOut(auth).then(() => {
        alert("Bis bald! üëã");
      }).catch((error) => {
        console.error("Logout error:", error);
      });
    }

    // Auth State
    onAuthStateChanged(auth, (user) => {
      console.log("Auth state changed:", user);
      if (user) {
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('mainApp').style.display = 'flex';
        document.getElementById('userEmail').textContent = user.email;
        document.getElementById('settingsUserEmail').textContent = user.email;
        loadServers();
        loadMessages();
      } else {
        document.getElementById('authSection').style.display = 'flex';
        document.getElementById('mainApp').style.display = 'none';
      }
    });

    // Send Message
    window.sendMessage = function() {
      const user = auth.currentUser;
      if (!user) {
        alert("Bitte erst einloggen!");
        return;
      }

      const msg = document.getElementById('messageInput').value;
      if (msg.trim() === "") return;

      const messageRef = ref(db, `servers/${currentServer}/channels/${currentChannel}/messages`);
      push(messageRef, { 
        text: msg, 
        sender: user.email,
        senderId: user.uid,
        timestamp: new Date().toISOString()
      });
      
      document.getElementById('messageInput').value = "";
    }

    // Load Messages
    function loadMessages() {
      const messagesContainer = document.getElementById('messagesContainer');
      messagesContainer.innerHTML = '';

      const messagesRef = ref(db, `servers/${currentServer}/channels/${currentChannel}/messages`);
      
      onChildAdded(messagesRef, (snapshot) => {
        const msg = snapshot.val();
        const messageDiv = document.createElement("div");
        messageDiv.className = "message";
        
        const time = new Date(msg.timestamp).toLocaleTimeString('de-DE', { 
          hour: '2-digit', 
          minute: '2-digit' 
        });
        
        messageDiv.innerHTML = `
          <div class="sender">
            ${msg.sender}
            <span class="timestamp">${time}</span>
          </div>
          <div>${msg.text}</div>
        `;
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      });
    }

    // Enter Key
    window.handleKeyPress = function(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    }

    // Server Functions
    window.selectServer = function(serverId) {
      currentServer = serverId;
      
      // Update UI
      document.querySelectorAll('.server-icon').forEach(icon => {
        icon.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // Update server name
      const serverName = serverId === 'global' ? 'Global Server' : servers[serverId]?.name || 'Unbekannt';
      document.getElementById('serverName').textContent = serverName;
      
      // Reset to general channel
      selectChannel('general');
    }

    window.selectChannel = function(channelId) {
      currentChannel = channelId;
      
      // Update UI
      document.querySelectorAll('.channel-item').forEach(item => {
        item.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // Update chat header
      const channelName = getChannelName(channelId);
      document.getElementById('chatHeader').textContent = `# ${channelName}`;
      document.getElementById('messageInput').placeholder = `Schreibe eine Nachricht in #${channelName}...`;
      
      // Load messages for this channel
      loadMessages();
    }

    function getChannelName(channelId) {
      const channelNames = {
        'general': 'üí¨ Allgemein',
        'games': 'üéÆ Gaming',
        'music': 'üéµ Musik'
      };
      return channelNames[channelId] || channelId;
    }

    // Modal Functions
    window.showCreateServerModal = function() {
      document.getElementById('createServerModal').style.display = 'flex';
    }

    window.hideCreateServerModal = function() {
      document.getElementById('createServerModal').style.display = 'none';
      document.getElementById('serverNameInput').value = '';
    }

    window.showCreateChannelModal = function() {
      document.getElementById('createChannelModal').style.display = 'flex';
    }

    window.hideCreateChannelModal = function() {
      document.getElementById('createChannelModal').style.display = 'none';
      document.getElementById('channelNameInput').value = '';
    }

    window.showSettings = function() {
      document.getElementById('settingsModal').style.display = 'flex';
    }

    window.hideSettingsModal = function() {
      document.getElementById('settingsModal').style.display = 'none';
    }

    // Create Server
    window.createServer = async function() {
      const serverName = document.getElementById('serverNameInput').value;
      if (!serverName) {
        alert("Gib einen Server-Namen ein!");
        return;
      }

      const user = auth.currentUser;
      if (!user) return;

      try {
        const serverRef = ref(db, 'servers');
        const newServerRef = push(serverRef);
        const serverId = newServerRef.key;

        await set(newServerRef, {
          name: serverName,
          owner: user.uid,
          createdAt: new Date().toISOString(),
          channels: {
            general: {
              name: "üí¨ Allgemein",
              createdBy: user.uid
            }
          }
        });

        // Add server to UI
        addServerToUI(serverId, serverName);
        hideCreateServerModal();
        alert(`Server "${serverName}" erstellt! üéâ`);

      } catch (error) {
        console.error("Error creating server:", error);
        alert("Fehler beim Erstellen des Servers: " + error.message);
      }
    }

    // Create Channel
    window.createChannel = async function() {
      const channelName = document.getElementById('channelNameInput').value;
      if (!channelName) {
        alert("Gib einen Channel-Namen ein!");
        return;
      }

      const user = auth.currentUser;
      if (!user) return;

      try {
        const channelId = channelName.toLowerCase().replace(/\s+/g, '-');
        const channelRef = ref(db, `servers/${currentServer}/channels/${channelId}`);
        
        await set(channelRef, {
          name: channelName,
          createdBy: user.uid,
          createdAt: new Date().toISOString()
        });

        // Add channel to UI
        const channelsList = document.getElementById('channelsList');
        const channelItem = document.createElement('li');
        channelItem.className = 'channel-item';
        channelItem.textContent = `# ${channelName}`;
        channelItem.onclick = () => selectChannel(channelId);
        channelsList.appendChild(channelItem);

        hideCreateChannelModal();
        alert(`Channel "${channelName}" erstellt! üéâ`);

      } catch (error) {
        console.error("Error creating channel:", error);
        alert("Fehler beim Erstellen des Channels: " + error.message);
      }
    }

    // Load Servers
    function loadServers() {
      const serversRef = ref(db, 'servers');
      const serversSidebar = document.getElementById('serversSidebar');

      onValue(serversRef, (snapshot) => {
        const data = snapshot.val();
        servers = data || {};

        // Clear existing servers (keep global and add button)
        const existingServers = serversSidebar.querySelectorAll('.server-icon:not(.add-server)');
        existingServers.forEach(server => {
          if (!server.onclick || !server.onclick.toString().includes('global')) {
            server.remove();
          }
        });

        // Add servers to UI
        Object.keys(servers).forEach(serverId => {
          addServerToUI(serverId, servers[serverId].name);
        });
      });
    }

    function addServerToUI(serverId, serverName) {
      const serversSidebar = document.getElementById('serversSidebar');
      const serverIcon = document.createElement('div');
      serverIcon.className = 'server-icon';
      serverIcon.textContent = serverName.charAt(0).toUpperCase();
      serverIcon.onclick = () => selectServer(serverId);
      
      // Insert before the add server button
      const addServerBtn = serversSidebar.querySelector('.add-server');
      serversSidebar.insertBefore(serverIcon, addServerBtn);
    }

    // Close modals when clicking outside
    window.onclick = function(event) {
      const modals = document.querySelectorAll('.modal');
      modals.forEach(modal => {
        if (event.target === modal) {
          modal.style.display = 'none';
        }
      });
    }
  </script>
</body>
</html>
