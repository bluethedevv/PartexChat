<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PartexChat</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-void: #050507;
      --bg-deep: #0c0c10;
      --bg-base: #111116;
      --bg-raised: #18181f;
      --bg-elevated: #1f1f28;
      --bg-hover: #26262f;
      --border: rgba(255,255,255,0.06);
      --border-glow: rgba(122,95,255,0.3);
      --accent: #7a5fff;
      --accent-soft: rgba(122,95,255,0.15);
      --accent-glow: rgba(122,95,255,0.4);
      --green: #4ade80;
      --green-soft: rgba(74,222,128,0.15);
      --blue: #38bdf8;
      --blue-soft: rgba(56,189,248,0.12);
      --red: #f87171;
      --red-soft: rgba(248,113,113,0.15);
      --amber: #fbbf24;
      --text-primary: #f0f0f5;
      --text-secondary: #9090a0;
      --text-muted: #5a5a6a;
      --radius: 10px;
      --radius-lg: 16px;
      --sidebar-w: 68px;
      --channels-w: 255px;
      --members-w: 230px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg-void);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
      font-size: 14px;
    }

    /* ‚îÄ‚îÄ‚îÄ SCROLLBARS ‚îÄ‚îÄ‚îÄ */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--bg-elevated); border-radius: 2px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

    /* ‚îÄ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ */
    #authSection {
      display: flex;
      height: 100vh;
      background: var(--bg-void);
      position: relative;
      overflow: hidden;
    }

    .auth-bg-orb {
      position: absolute;
      border-radius: 50%;
      filter: blur(80px);
      pointer-events: none;
    }
    .auth-bg-orb.orb1 {
      width: 500px; height: 500px;
      background: radial-gradient(circle, rgba(122,95,255,0.2), transparent 70%);
      top: -150px; left: -150px;
    }
    .auth-bg-orb.orb2 {
      width: 400px; height: 400px;
      background: radial-gradient(circle, rgba(56,189,248,0.12), transparent 70%);
      bottom: -100px; right: -100px;
    }

    .auth-left {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 60px;
      position: relative;
    }

    .auth-brand {
      font-family: 'Syne', sans-serif;
      font-weight: 800;
      font-size: 2.2rem;
      color: var(--text-primary);
      letter-spacing: -1px;
      margin-bottom: 0.5rem;
    }

    .auth-brand span {
      background: linear-gradient(135deg, var(--accent), var(--blue));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .auth-tagline {
      color: var(--text-muted);
      font-size: 1rem;
      margin-bottom: 3rem;
      line-height: 1.6;
    }

    .auth-features {
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
    }

    .auth-feature {
      display: flex;
      align-items: center;
      gap: 1rem;
      color: var(--text-secondary);
      font-size: 1rem;
    }

    .auth-feature-icon {
      width: 44px;
      height: 44px;
      background: var(--bg-raised);
      border: 1px solid var(--border);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
      flex-shrink: 0;
    }

    .auth-right {
      width: 440px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      position: relative;
    }

    .auth-card {
      background: var(--bg-raised);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 2.5rem;
      width: 100%;
      position: relative;
      backdrop-filter: blur(10px);
    }

    .auth-card::before {
      content: '';
      position: absolute;
      inset: -1px;
      border-radius: var(--radius-lg);
      padding: 1px;
      background: linear-gradient(135deg, rgba(122,95,255,0.4), transparent, rgba(56,189,248,0.2));
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events: none;
    }

    .auth-tabs {
      display: flex;
      gap: 0.3rem;
      margin-bottom: 2rem;
      background: var(--bg-deep);
      padding: 4px;
      border-radius: 8px;
    }

    .auth-tab {
      flex: 1;
      padding: 0.6rem;
      background: transparent;
      border: none;
      color: var(--text-muted);
      border-radius: 6px;
      cursor: pointer;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.85rem;
      font-weight: 500;
      transition: all 0.2s;
    }

    .auth-tab.active {
      background: var(--bg-elevated);
      color: var(--text-primary);
    }

    .auth-title {
      font-family: 'Syne', sans-serif;
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 0.4rem;
    }

    .auth-subtitle {
      color: var(--text-muted);
      font-size: 0.85rem;
      margin-bottom: 1.8rem;
    }

    .field-group { margin-bottom: 1rem; }

    .field-label {
      display: block;
      color: var(--text-secondary);
      font-size: 0.8rem;
      font-weight: 500;
      margin-bottom: 0.4rem;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .field-input {
      width: 100%;
      padding: 0.75rem 1rem;
      background: var(--bg-deep);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text-primary);
      font-family: 'DM Sans', sans-serif;
      font-size: 0.9rem;
      transition: border-color 0.2s, box-shadow 0.2s;
      outline: none;
    }

    .field-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }

    .auth-btn {
      width: 100%;
      padding: 0.85rem;
      background: var(--accent);
      border: none;
      border-radius: var(--radius);
      color: white;
      font-family: 'Syne', sans-serif;
      font-size: 0.95rem;
      font-weight: 700;
      cursor: pointer;
      margin-top: 0.5rem;
      transition: opacity 0.2s, transform 0.15s;
      letter-spacing: 0.02em;
    }

    .auth-btn:hover { opacity: 0.88; transform: translateY(-1px); }
    .auth-btn:active { transform: translateY(0); }

    .auth-error {
      color: var(--red);
      background: var(--red-soft);
      border: 1px solid rgba(248,113,113,0.2);
      border-radius: 8px;
      padding: 0.7rem 1rem;
      font-size: 0.85rem;
      margin-bottom: 1rem;
      display: none;
    }

    /* ‚îÄ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ‚îÄ */
    #mainApp {
      display: none;
      height: 100vh;
      flex-direction: row;
    }

    /* ‚îÄ‚îÄ‚îÄ SERVER SIDEBAR ‚îÄ‚îÄ‚îÄ */
    .server-rail {
      width: var(--sidebar-w);
      background: var(--bg-void);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0.75rem 0;
      gap: 0.5rem;
      border-right: 1px solid var(--border);
    }

    .rail-divider {
      width: 36px;
      height: 1px;
      background: var(--border);
      margin: 0.25rem 0;
    }

    .rail-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--bg-raised);
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.1rem;
      color: var(--text-secondary);
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
      flex-shrink: 0;
    }

    .rail-btn:hover {
      background: var(--bg-elevated);
      color: var(--text-primary);
      border-color: rgba(255,255,255,0.12);
      transform: scale(1.05);
    }

    .rail-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
      border-radius: 14px;
    }

    .rail-btn.dm-btn.active {
      background: var(--blue);
      border-color: var(--blue);
      border-radius: 14px;
    }

    .rail-btn.add-btn {
      color: var(--green);
      font-size: 1.4rem;
    }

    .rail-btn.add-btn:hover {
      background: var(--green-soft);
      border-color: rgba(74,222,128,0.3);
      color: var(--green);
    }

    .rail-tooltip {
      position: absolute;
      left: calc(100% + 12px);
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      padding: 0.4rem 0.7rem;
      border-radius: 6px;
      font-size: 0.8rem;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s;
      z-index: 100;
    }

    .rail-btn:hover .rail-tooltip { opacity: 1; }

    /* ‚îÄ‚îÄ‚îÄ CHANNELS PANEL ‚îÄ‚îÄ‚îÄ */
    .channels-panel {
      width: var(--channels-w);
      background: var(--bg-deep);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
    }

    .panel-header {
      padding: 1rem 1rem 0.75rem;
      border-bottom: 1px solid var(--border);
    }

    .panel-server-name {
      font-family: 'Syne', sans-serif;
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: 0.01em;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .panel-actions {
      display: flex;
      gap: 0.25rem;
    }

    .panel-action-btn {
      width: 28px;
      height: 28px;
      background: transparent;
      border: none;
      border-radius: 6px;
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .panel-action-btn:hover {
      background: var(--bg-elevated);
      color: var(--text-primary);
    }

    .panel-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 0.75rem;
    }

    .section-label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: var(--text-muted);
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 0 0.5rem;
      margin-bottom: 0.4rem;
      margin-top: 0.75rem;
    }

    .section-label:first-child { margin-top: 0; }

    .section-add-btn {
      width: 20px;
      height: 20px;
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      transition: all 0.2s;
    }
    .section-add-btn:hover { background: var(--bg-elevated); color: var(--text-primary); }

    .channel-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.55rem 0.75rem;
      border-radius: 8px;
      cursor: pointer;
      color: var(--text-muted);
      font-size: 0.875rem;
      transition: all 0.15s;
      position: relative;
    }

    .channel-row:hover {
      background: var(--bg-hover);
      color: var(--text-secondary);
    }

    .channel-row.active {
      background: var(--accent-soft);
      color: var(--text-primary);
    }

    .channel-row.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 25%;
      bottom: 25%;
      width: 3px;
      background: var(--accent);
      border-radius: 0 3px 3px 0;
    }

    .ch-icon {
      font-size: 0.85rem;
      width: 18px;
      text-align: center;
    }

    /* DM List */
    .dm-item {
      display: flex;
      align-items: center;
      gap: 0.65rem;
      padding: 0.5rem 0.75rem;
      border-radius: 8px;
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.15s;
      position: relative;
    }

    .dm-item:hover {
      background: var(--bg-hover);
      color: var(--text-secondary);
    }

    .dm-item.active {
      background: var(--blue-soft);
      color: var(--text-primary);
    }

    .dm-avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--blue));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
      color: white;
      flex-shrink: 0;
      position: relative;
    }

    .status-dot {
      position: absolute;
      bottom: -1px;
      right: -1px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 2px solid var(--bg-deep);
    }

    .status-dot.online { background: var(--green); }
    .status-dot.offline { background: var(--text-muted); }

    .dm-info { flex: 1; min-width: 0; }

    .dm-name {
      font-size: 0.875rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .dm-status-text {
      font-size: 0.72rem;
      color: var(--text-muted);
      margin-top: 1px;
    }

    .dm-close-btn {
      width: 20px;
      height: 20px;
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      border-radius: 4px;
      font-size: 0.8rem;
      display: none;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }

    .dm-item:hover .dm-close-btn { display: flex; }
    .dm-close-btn:hover { background: var(--red-soft); color: var(--red); }

    /* Friend request badge */
    .req-badge {
      background: var(--amber);
      color: var(--bg-void);
      font-size: 0.65rem;
      font-weight: 700;
      min-width: 16px;
      height: 16px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 3px;
    }

    /* ‚îÄ‚îÄ‚îÄ CHAT AREA ‚îÄ‚îÄ‚îÄ */
    .chat-pane {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--bg-base);
      min-width: 0;
    }

    .chat-topbar {
      height: 52px;
      background: var(--bg-deep);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 1.25rem;
      gap: 0.75rem;
    }

    .topbar-icon {
      color: var(--text-muted);
      font-size: 1rem;
    }

    .topbar-name {
      font-family: 'Syne', sans-serif;
      font-size: 0.95rem;
      font-weight: 700;
      flex: 1;
    }

    .topbar-actions {
      display: flex;
      gap: 0.4rem;
    }

    .topbar-btn {
      width: 32px;
      height: 32px;
      background: transparent;
      border: none;
      border-radius: 8px;
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      transition: all 0.15s;
    }

    .topbar-btn:hover {
      background: var(--bg-elevated);
      color: var(--text-primary);
    }

    .topbar-btn.call-active {
      background: var(--green-soft);
      color: var(--green);
    }

    /* Messages */
    .messages-feed {
      flex: 1;
      overflow-y: auto;
      padding: 1rem 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .day-divider {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      color: var(--text-muted);
      font-size: 0.75rem;
      margin: 1rem 0 0.5rem;
    }

    .day-divider::before, .day-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    .welcome-card {
      background: linear-gradient(135deg, var(--accent-soft), var(--blue-soft));
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 2rem;
      text-align: center;
      margin-bottom: 1rem;
    }

    .welcome-card h3 {
      font-family: 'Syne', sans-serif;
      font-size: 1.3rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .welcome-card p {
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    /* Message Group */
    .msg-group {
      display: flex;
      gap: 0.75rem;
      padding: 0.3rem 0;
      border-radius: var(--radius);
      transition: background 0.1s;
    }

    .msg-group:hover {
      background: var(--bg-raised);
    }

    .msg-avatar-wrap {
      width: 36px;
      flex-shrink: 0;
    }

    .msg-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--blue));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      font-weight: 700;
      color: white;
      cursor: pointer;
    }

    .msg-body { flex: 1; min-width: 0; }

    .msg-meta {
      display: flex;
      align-items: baseline;
      gap: 0.5rem;
      margin-bottom: 0.2rem;
    }

    .msg-sender {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-primary);
      cursor: pointer;
    }

    .msg-sender:hover { color: var(--accent); }

    .msg-sender.dm-sender { color: var(--blue); }
    .msg-sender.dm-sender:hover { color: #7dd3fc; }

    .msg-time {
      font-size: 0.72rem;
      color: var(--text-muted);
    }

    .msg-text {
      color: #c8c8d5;
      line-height: 1.5;
      font-size: 0.875rem;
      word-break: break-word;
    }

    .msg-text.system {
      color: var(--text-muted);
      font-style: italic;
      font-size: 0.8rem;
    }

    .msg-image {
      max-width: 380px;
      max-height: 320px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      display: block;
      margin-top: 0.4rem;
      cursor: zoom-in;
      transition: border-color 0.2s;
    }

    .msg-image:hover { border-color: var(--accent); }

    .msg-actions {
      display: none;
      gap: 0.25rem;
      margin-left: auto;
    }

    .msg-group:hover .msg-actions { display: flex; }

    .msg-action-btn {
      width: 28px;
      height: 28px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }

    .msg-action-btn:hover { background: var(--red-soft); border-color: rgba(248,113,113,0.3); color: var(--red); }

    /* Input */
    .input-zone {
      padding: 0 1.25rem 1.25rem;
    }

    .input-box {
      background: var(--bg-raised);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 0.75rem 0.75rem 0.5rem;
      transition: border-color 0.2s;
    }

    .input-box:focus-within {
      border-color: rgba(122,95,255,0.3);
    }

    .input-row {
      display: flex;
      align-items: flex-end;
      gap: 0.5rem;
    }

    #messageInput {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text-primary);
      font-family: 'DM Sans', sans-serif;
      font-size: 0.9rem;
      resize: none;
      min-height: 36px;
      max-height: 160px;
      line-height: 1.5;
      outline: none;
    }

    #messageInput::placeholder { color: var(--text-muted); }
    #messageInput:disabled { cursor: not-allowed; opacity: 0.5; }

    .input-tools {
      display: flex;
      gap: 0.25rem;
      align-items: center;
    }

    .tool-btn {
      width: 32px;
      height: 32px;
      background: transparent;
      border: none;
      border-radius: 8px;
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      transition: all 0.15s;
    }

    .tool-btn:hover { background: var(--bg-elevated); color: var(--text-primary); }

    .send-btn {
      width: 36px;
      height: 36px;
      background: var(--accent);
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      transition: all 0.15s;
      flex-shrink: 0;
    }

    .send-btn:hover { background: #6a4fee; transform: scale(1.05); }
    .send-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    .img-preview-strip {
      display: none;
      margin-bottom: 0.5rem;
    }

    .img-preview-strip img {
      height: 80px;
      border-radius: 8px;
      border: 2px solid var(--accent);
      position: relative;
    }

    .img-preview-strip-inner {
      display: inline-flex;
      position: relative;
    }

    .img-preview-remove {
      position: absolute;
      top: -6px;
      right: -6px;
      width: 18px;
      height: 18px;
      background: var(--red);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 0.7rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ‚îÄ‚îÄ‚îÄ MEMBERS PANEL ‚îÄ‚îÄ‚îÄ */
    .members-panel {
      width: var(--members-w);
      background: var(--bg-deep);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
    }

    .members-top {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      font-family: 'Syne', sans-serif;
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--text-muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .members-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
    }

    .member-row {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      padding: 0.45rem 0.6rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.15s;
    }

    .member-row:hover { background: var(--bg-elevated); }

    .member-av {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--blue));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
      color: white;
      position: relative;
      flex-shrink: 0;
    }

    .member-name {
      flex: 1;
      font-size: 0.875rem;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ‚îÄ‚îÄ‚îÄ USER BOTTOM BAR ‚îÄ‚îÄ‚îÄ */
    .user-bar {
      margin-top: auto;
      padding: 0.75rem;
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 0.6rem;
      background: rgba(0,0,0,0.2);
      cursor: pointer;
      transition: background 0.15s;
    }

    .user-bar:hover { background: var(--bg-elevated); }

    .user-bar-av {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--blue));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 700;
      color: white;
      flex-shrink: 0;
    }

    .user-bar-info { flex: 1; min-width: 0; }

    .user-bar-name {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .user-bar-status {
      font-size: 0.72rem;
      color: var(--green);
    }

    .user-bar-logout {
      width: 28px;
      height: 28px;
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      transition: all 0.15s;
    }

    .user-bar-logout:hover { background: var(--red-soft); color: var(--red); }

    /* ‚îÄ‚îÄ‚îÄ CALL OVERLAY ‚îÄ‚îÄ‚îÄ */
    .call-overlay {
      display: none;
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 340px;
      background: var(--bg-raised);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.6);
      z-index: 200;
    }

    .call-overlay-header {
      padding: 0.75rem 1rem;
      background: var(--accent-soft);
      border-bottom: 1px solid var(--border-glow);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .call-overlay-title {
      font-family: 'Syne', sans-serif;
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--accent);
    }

    .call-overlay-close {
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 1.2rem;
    }

    .call-video-area {
      position: relative;
      height: 200px;
      background: var(--bg-void);
    }

    .call-video-area video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #localVideo {
      position: absolute;
      bottom: 8px;
      right: 8px;
      width: 80px;
      height: 60px;
      border-radius: 8px;
      border: 2px solid var(--accent);
      object-fit: cover;
      z-index: 2;
    }

    #remoteVideo {
      width: 100%;
      height: 100%;
    }

    .call-btns {
      display: flex;
      gap: 0.75rem;
      justify-content: center;
      padding: 1rem;
    }

    .call-circle-btn {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      font-size: 1.2rem;
      transition: all 0.2s;
    }

    .call-circle-btn:hover { transform: scale(1.1); }

    .call-circle-btn.mute { background: var(--bg-elevated); color: var(--text-primary); }
    .call-circle-btn.mute.muted { background: var(--red-soft); color: var(--red); }
    .call-circle-btn.end-call { background: var(--red); color: white; }

    /* ‚îÄ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ‚îÄ */
    .modal-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(6px);
      z-index: 500;
      align-items: center;
      justify-content: center;
    }

    .modal-box {
      background: var(--bg-raised);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 2rem;
      width: 90%;
      max-width: 460px;
      position: relative;
    }

    .modal-box::before {
      content: '';
      position: absolute;
      inset: -1px;
      border-radius: var(--radius-lg);
      padding: 1px;
      background: linear-gradient(135deg, rgba(122,95,255,0.35), transparent);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events: none;
    }

    .modal-title {
      font-family: 'Syne', sans-serif;
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 0.4rem;
    }

    .modal-sub {
      color: var(--text-muted);
      font-size: 0.82rem;
      margin-bottom: 1.5rem;
    }

    .modal-input, .modal-textarea, .modal-select {
      width: 100%;
      padding: 0.75rem 1rem;
      background: var(--bg-deep);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text-primary);
      font-family: 'DM Sans', sans-serif;
      font-size: 0.875rem;
      margin-bottom: 0.75rem;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .modal-input:focus, .modal-textarea:focus, .modal-select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-soft);
    }

    .modal-textarea { min-height: 100px; resize: vertical; }

    .modal-select { appearance: none; cursor: pointer; }

    .modal-btns {
      display: flex;
      gap: 0.75rem;
      margin-top: 1.25rem;
    }

    .modal-btn-primary {
      flex: 1;
      padding: 0.75rem;
      background: var(--accent);
      border: none;
      border-radius: var(--radius);
      color: white;
      font-family: 'Syne', sans-serif;
      font-weight: 700;
      cursor: pointer;
      transition: opacity 0.15s;
    }

    .modal-btn-primary:hover { opacity: 0.85; }

    .modal-btn-secondary {
      padding: 0.75rem 1.25rem;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text-secondary);
      font-family: 'DM Sans', sans-serif;
      cursor: pointer;
      transition: all 0.15s;
    }

    .modal-btn-secondary:hover { background: var(--bg-hover); color: var(--text-primary); }

    /* Friend request inside modal */
    .friend-req-card {
      background: var(--bg-deep);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.5rem;
    }

    .freq-info { flex: 1; }
    .freq-name { font-size: 0.875rem; font-weight: 600; }
    .freq-sub { font-size: 0.75rem; color: var(--text-muted); }

    .freq-btns { display: flex; gap: 0.4rem; }

    .freq-btn {
      padding: 0.35rem 0.7rem;
      border: none;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.15s;
    }

    .freq-btn:hover { opacity: 0.8; }
    .freq-btn.accept { background: var(--green); color: var(--bg-void); }
    .freq-btn.reject { background: var(--bg-elevated); color: var(--text-secondary); }

    /* Profile modal */
    .profile-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .profile-av-large {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--blue));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.6rem;
      font-weight: 700;
      color: white;
    }

    .profile-info { flex: 1; }
    .profile-name { font-family: 'Syne', sans-serif; font-size: 1.2rem; font-weight: 700; }
    .profile-email { color: var(--text-muted); font-size: 0.8rem; margin-top: 0.2rem; }

    .profile-stat-row {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .profile-stat {
      flex: 1;
      background: var(--bg-deep);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 0.75rem;
      text-align: center;
    }

    .profile-stat-value {
      font-family: 'Syne', sans-serif;
      font-size: 1.3rem;
      font-weight: 800;
      color: var(--accent);
    }

    .profile-stat-label {
      font-size: 0.72rem;
      color: var(--text-muted);
      margin-top: 0.2rem;
    }

    .profile-bio-box {
      background: var(--bg-deep);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 0.75rem 1rem;
      color: var(--text-secondary);
      font-size: 0.875rem;
      line-height: 1.5;
      margin-bottom: 0.75rem;
    }

    /* Image modal */
    .img-modal-box {
      background: transparent;
      border: none;
      max-width: 90vw;
      text-align: center;
    }

    .img-modal-box img {
      max-width: 100%;
      max-height: 85vh;
      border-radius: var(--radius);
    }

    /* Friend requests section */
    #friendRequestsSection {
      margin-top: 1rem;
    }

    /* Typing indicator */
    .typing-indicator {
      display: none;
      align-items: center;
      gap: 0.5rem;
      padding: 0.25rem 0 0.5rem;
      color: var(--text-muted);
      font-size: 0.78rem;
      padding-left: 0.5rem;
    }

    .typing-dots span {
      display: inline-block;
      width: 5px;
      height: 5px;
      background: var(--text-muted);
      border-radius: 50%;
      margin: 0 1px;
      animation: bounce 1.2s infinite;
    }

    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-4px); }
    }

    /* Notification toast */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 0.85rem 1.2rem;
      color: var(--text-primary);
      font-size: 0.875rem;
      z-index: 9999;
      transform: translateX(400px);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      max-width: 300px;
    }

    .toast.show { transform: translateX(0); }
    .toast.success { border-color: rgba(74,222,128,0.3); background: rgba(74,222,128,0.05); }
    .toast.error { border-color: rgba(248,113,113,0.3); background: rgba(248,113,113,0.05); }

    /* Responsive */
    @media (max-width: 900px) {
      .members-panel { display: none; }
      :root { --channels-w: 220px; }
    }

    @media (max-width: 600px) {
      .channels-panel { display: none; }
      .auth-left { display: none; }
      .auth-right { width: 100%; }
    }
  </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="authSection">
  <div class="auth-bg-orb orb1"></div>
  <div class="auth-bg-orb orb2"></div>

  <div class="auth-left">
    <div class="auth-features">
      <div class="auth-feature"><div class="auth-feature-icon">üí¨</div> Real-time messaging</div>
      <div class="auth-feature"><div class="auth-feature-icon">üë•</div> Friends &amp; Direct Messages</div>
      <div class="auth-feature"><div class="auth-feature-icon">üì°</div> Public servers &amp; channels</div>
      <div class="auth-feature"><div class="auth-feature-icon">üì∑</div> Image sharing</div>
    </div>
  </div>

  <div class="auth-right">
    <div class="auth-card">
      <div class="auth-tabs">
        <button class="auth-tab active" id="tabLogin" onclick="switchAuthTab('login')">Sign In</button>
        <button class="auth-tab" id="tabRegister" onclick="switchAuthTab('register')">Create Account</button>
      </div>

      <!-- Login -->
      <div id="loginForm">
        <div class="auth-title">Welcome back</div>
        <div class="auth-subtitle">Sign in to continue chatting</div>
        <div id="loginError" class="auth-error"></div>
        <div class="field-group">
          <label class="field-label">Email</label>
          <input type="email" id="loginEmail" class="field-input" placeholder="you@example.com" autocomplete="email">
        </div>
        <div class="field-group">
          <label class="field-label">Password</label>
          <input type="password" id="loginPassword" class="field-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
        </div>
        <button class="auth-btn" onclick="login()">Sign In ‚Üí</button>
      </div>

      <!-- Register -->
      <div id="registerForm" style="display:none;">
        <div class="auth-title">Join PartexChat</div>
        <div class="auth-subtitle">Create your account for free</div>
        <div id="registerError" class="auth-error"></div>
        <div class="field-group">
          <label class="field-label">Username</label>
          <input type="text" id="registerUsername" class="field-input" placeholder="cooluser123" autocomplete="username">
        </div>
        <div class="field-group">
          <label class="field-label">Email</label>
          <input type="email" id="registerEmail" class="field-input" placeholder="you@example.com" autocomplete="email">
        </div>
        <div class="field-group">
          <label class="field-label">Password</label>
          <input type="password" id="registerPassword" class="field-input" placeholder="Min. 6 characters" autocomplete="new-password">
        </div>
        <button class="auth-btn" onclick="register()">Create Account ‚Üí</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN APP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="mainApp">

  <!-- Server Rail -->
  <div class="server-rail" id="serverRail">
    <div class="rail-btn active" id="railGlobal" onclick="selectServer('global', this)">
      üåç
      <span class="rail-tooltip">Global Server</span>
    </div>
    <div class="rail-btn dm-btn" id="railDMs" onclick="selectServer('dms', this)">
      üí¨
      <span class="rail-tooltip">Direct Messages</span>
    </div>
    <div class="rail-divider"></div>
    <!-- Dynamic servers appended here -->
    <div class="rail-btn add-btn" id="addServerBtn" onclick="openModal('createServerModal')">
      +
      <span class="rail-tooltip">Create Server</span>
    </div>
  </div>

  <!-- Channels Panel -->
  <div class="channels-panel">
    <div class="panel-header">
      <div class="panel-server-name">
        <span id="panelServerName">Global Server</span>
        <div class="panel-actions" id="panelActions">
          <button class="panel-action-btn" onclick="showInvite()" title="Invite">üì®</button>
          <button class="panel-action-btn" onclick="toast('Server settings coming soon!', 'info')" title="Settings">‚öôÔ∏è</button>
        </div>
      </div>
    </div>

    <div class="panel-scroll">
      <!-- Server Channels -->
      <div id="channelsSection">
        <div class="section-label">
          <span>Channels</span>
          <button class="section-add-btn" onclick="openModal('createChannelModal')" title="New Channel">+</button>
        </div>
        <ul id="channelsList" style="list-style:none;">
          <li class="channel-row active" id="ch-welcome" onclick="selectChannel('welcome', this)">
            <span class="ch-icon">#</span> welcome
          </li>
          <li class="channel-row" id="ch-general" onclick="selectChannel('general', this)">
            <span class="ch-icon">#</span> general
          </li>
        </ul>
      </div>

      <!-- DMs Section -->
      <div id="dmsSection" style="display:none;">
        <div class="section-label">
          <span>Friends</span>
          <button class="section-add-btn" onclick="openModal('addFriendModal')" title="Add Friend">+</button>
        </div>
        <div id="friendsList"></div>

        <div id="friendRequestsSection">
          <div class="section-label" style="margin-top:1rem;">
            <span>Requests</span>
            <span class="req-badge" id="reqBadge" style="display:none;">0</span>
          </div>
          <div id="friendRequestsList"></div>
        </div>
      </div>
    </div>

    <!-- User Bar -->
    <div class="user-bar" onclick="openModal('profileModal')">
      <div class="user-bar-av" id="userBarAv">U</div>
      <div class="user-bar-info">
        <div class="user-bar-name" id="userBarName">Username</div>
        <div class="user-bar-status">‚óè Online</div>
      </div>
      <button class="user-bar-logout" onclick="event.stopPropagation(); logout()" title="Logout">‚éã</button>
    </div>
  </div>

  <!-- Chat Pane -->
  <div class="chat-pane">
    <div class="chat-topbar">
      <span class="topbar-icon" id="topbarIcon">#</span>
      <span class="topbar-name" id="topbarName">welcome</span>
      <div class="topbar-actions">
        <button class="topbar-btn call-active" id="callBtn" style="display:none;" onclick="startCall()" title="Start Call">üìû</button>
      </div>
    </div>

    <div class="messages-feed" id="messagesFeed">
      <div class="welcome-card">
        <h3>Welcome to PartexChat üöÄ</h3>
        <p>This is the beginning of your conversation. Say something!</p>
      </div>
    </div>

    <div class="input-zone">
      <div class="input-box">
        <div class="img-preview-strip" id="imgPreviewStrip">
          <div class="img-preview-strip-inner">
            <img id="imgPreviewImg" alt="preview">
            <button class="img-preview-remove" onclick="clearImagePreview()">‚úï</button>
          </div>
        </div>
        <div class="input-row">
          <textarea id="messageInput" placeholder="Type a message..." rows="1" onkeydown="handleKey(event)" oninput="autoGrow(this)"></textarea>
          <div class="input-tools">
            <input type="file" id="fileInput" accept="image/*" style="display:none;" onchange="handleFileSelect(event)">
            <button class="tool-btn" onclick="document.getElementById('fileInput').click()" title="Attach image">üì∑</button>
            <button class="send-btn" onclick="sendMessage()" id="sendBtn">
              ‚û§
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Members Panel -->
  <div class="members-panel">
    <div class="members-top">Members</div>
    <div class="members-scroll" id="membersList"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CALL OVERLAY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="call-overlay" id="callOverlay">
  <div class="call-overlay-header">
    <span class="call-overlay-title" id="callTitle">üìû In Call</span>
    <button class="call-overlay-close" onclick="endCall()">‚úï</button>
  </div>
  <div class="call-video-area">
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay muted playsinline></video>
  </div>
  <div class="call-btns">
    <button class="call-circle-btn mute" id="muteBtn" onclick="toggleMute()">üé§</button>
    <button class="call-circle-btn end-call" onclick="endCall()">üìµ</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<!-- Create Server -->
<div class="modal-backdrop" id="createServerModal">
  <div class="modal-box">
    <div class="modal-title">Create a Server</div>
    <div class="modal-sub">Give your new server a name</div>
    <input type="text" id="serverNameInput" class="modal-input" placeholder="My Awesome Server">
    <div class="modal-btns">
      <button class="modal-btn-secondary" onclick="closeModal('createServerModal')">Cancel</button>
      <button class="modal-btn-primary" onclick="createServer()">Create Server</button>
    </div>
  </div>
</div>

<!-- Create Channel -->
<div class="modal-backdrop" id="createChannelModal">
  <div class="modal-box">
    <div class="modal-title">New Channel</div>
    <div class="modal-sub">Add a channel to this server</div>
    <input type="text" id="channelNameInput" class="modal-input" placeholder="channel-name">
    <div class="modal-btns">
      <button class="modal-btn-secondary" onclick="closeModal('createChannelModal')">Cancel</button>
      <button class="modal-btn-primary" onclick="createChannel()">Create Channel</button>
    </div>
  </div>
</div>

<!-- Add Friend -->
<div class="modal-backdrop" id="addFriendModal">
  <div class="modal-box">
    <div class="modal-title">Add Friend</div>
    <div class="modal-sub">Send a friend request by username</div>
    <input type="text" id="friendUsernameInput" class="modal-input" placeholder="Enter username...">
    <div class="modal-btns">
      <button class="modal-btn-secondary" onclick="closeModal('addFriendModal')">Cancel</button>
      <button class="modal-btn-primary" onclick="sendFriendRequest()">Send Request</button>
    </div>
  </div>
</div>

<!-- Profile -->
<div class="modal-backdrop" id="profileModal">
  <div class="modal-box">
    <div class="profile-header">
      <div class="profile-av-large" id="profileAv">U</div>
      <div class="profile-info">
        <div class="profile-name" id="profileName">Username</div>
        <div class="profile-email" id="profileEmail">user@example.com</div>
      </div>
    </div>
    <div class="profile-stat-row">
      <div class="profile-stat">
        <div class="profile-stat-value" id="profileFriends">0</div>
        <div class="profile-stat-label">Friends</div>
      </div>
      <div class="profile-stat">
        <div class="profile-stat-value" id="profileSince">‚Äî</div>
        <div class="profile-stat-label">Member Since</div>
      </div>
    </div>
    <div class="profile-bio-box" id="profileBio">No bio yet.</div>
    <div class="modal-btns">
      <button class="modal-btn-secondary" onclick="closeModal('profileModal')">Close</button>
      <button class="modal-btn-primary" onclick="openEditProfile()">Edit Profile</button>
    </div>
  </div>
</div>

<!-- Edit Profile -->
<div class="modal-backdrop" id="editProfileModal">
  <div class="modal-box">
    <div class="modal-title">Edit Profile</div>
    <div class="modal-sub">Update your public information</div>
    <label class="field-label">Username</label>
    <input type="text" id="editUsername" class="modal-input" placeholder="Username">
    <label class="field-label">Bio</label>
    <textarea id="editBio" class="modal-textarea" placeholder="Tell us about yourself..."></textarea>
    <label class="field-label">Status</label>
    <select id="editStatus" class="modal-select">
      <option value="online">üü¢ Online</option>
      <option value="idle">üåô Idle</option>
      <option value="dnd">‚õî Do Not Disturb</option>
      <option value="offline">‚ö´ Offline</option>
    </select>
    <div class="modal-btns">
      <button class="modal-btn-secondary" onclick="closeModal('editProfileModal')">Cancel</button>
      <button class="modal-btn-primary" onclick="saveProfile()">Save Changes</button>
    </div>
  </div>
</div>

<!-- Image Viewer -->
<div class="modal-backdrop" id="imageModal" onclick="closeModal('imageModal')">
  <div class="modal-box img-modal-box">
    <img id="enlargedImg" alt="full size">
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref, set, push, onChildAdded, onValue, get, remove, update, off } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyBWxwGrVmF2IQEGIyEZCtwp9vsRdpGAnRs",
  authDomain: "partexchat.firebaseapp.com",
  databaseURL: "https://partexchat-default-rtdb.firebaseio.com",
  projectId: "partexchat",
  storageBucket: "partexchat.firebasestorage.app",
  messagingSenderId: "348087049579",
  appId: "1:348087049579:web:a61c4aef9e7272505d802e",
  measurementId: "G-KY5XWKYY0D"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const storage = getStorage(app);

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let currentUser = null;
let currentServer = 'global';
let currentChannel = 'welcome';
let currentDmUid = null;
let msgListener = null;
let friendsUnsub = null;
let reqsUnsub = null;
let selectedFile = null;
let peerConn = null;
let localStream = null;
let isMuted = false;

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
window.toast = function(msg, type = 'info') {
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  document.body.appendChild(el);
  requestAnimationFrame(() => el.classList.add('show'));
  setTimeout(() => {
    el.classList.remove('show');
    setTimeout(() => el.remove(), 350);
  }, 3000);
};

window._openModalProfile = async function() {};

window.openModal = async function(id) {
  if (id === 'profileModal') {
    await window._openModalProfile();
  }
  document.getElementById(id).style.display = 'flex';
};
window.closeModal = id => { document.getElementById(id).style.display = 'none'; };

// Close modal on backdrop click
document.querySelectorAll('.modal-backdrop').forEach(el => {
  el.addEventListener('click', e => {
    if (e.target === el) closeModal(el.id);
  });
});

// ‚îÄ‚îÄ AUTH TAB ‚îÄ‚îÄ
window.switchAuthTab = function(tab) {
  document.getElementById('loginForm').style.display = tab === 'login' ? 'block' : 'none';
  document.getElementById('registerForm').style.display = tab === 'register' ? 'block' : 'none';
  document.getElementById('tabLogin').classList.toggle('active', tab === 'login');
  document.getElementById('tabRegister').classList.toggle('active', tab === 'register');
};

function showErr(id, msg) {
  const el = document.getElementById(id);
  el.textContent = msg;
  el.style.display = 'block';
}

function hideErr(id) { document.getElementById(id).style.display = 'none'; }

// ‚îÄ‚îÄ REGISTER ‚îÄ‚îÄ
window.register = async function() {
  hideErr('registerError');
  const username = document.getElementById('registerUsername').value.trim();
  const email = document.getElementById('registerEmail').value.trim();
  const password = document.getElementById('registerPassword').value;
  if (!username || !email || !password) return showErr('registerError', 'Please fill all fields');
  if (username.length < 3) return showErr('registerError', 'Username must be at least 3 characters');
  if (password.length < 6) return showErr('registerError', 'Password must be at least 6 characters');
  try {
    const cred = await createUserWithEmailAndPassword(auth, email, password);
    const uid = cred.user.uid;
    await set(ref(db, `users/${uid}`), {
      username, email,
      avatar: username[0].toUpperCase(),
      bio: '',
      status: 'online',
      createdAt: new Date().toISOString(),
      isOnline: true,
      lastSeen: new Date().toISOString()
    });
    await set(ref(db, `usernames/${username.toLowerCase()}`), uid);
    await push(ref(db, 'servers/global/channels/welcome/messages'), {
      text: `üéâ Welcome ${username} to PartexChat!`,
      sender: 'System', senderId: 'system', senderAvatar: 'ü§ñ',
      timestamp: new Date().toISOString(), isSystem: true
    });
  } catch(e) { showErr('registerError', e.message); }
};

// ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ
window.login = async function() {
  hideErr('loginError');
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  if (!email || !password) return showErr('loginError', 'Please fill all fields');
  try {
    await signInWithEmailAndPassword(auth, email, password);
  } catch(e) { showErr('loginError', 'Invalid email or password'); }
};

// ‚îÄ‚îÄ LOGOUT ‚îÄ‚îÄ
window.logout = async function() {
  if (currentUser) {
    await update(ref(db, `users/${currentUser.uid}`), { isOnline: false, lastSeen: new Date().toISOString() });
    endCall();
  }
  await signOut(auth);
};

// ‚îÄ‚îÄ AUTH STATE ‚îÄ‚îÄ
onAuthStateChanged(auth, async user => {
  if (user) {
    let snap = await get(ref(db, `users/${user.uid}`));
    if (!snap.exists()) {
      await set(ref(db, `users/${user.uid}`), {
        username: user.email.split('@')[0], email: user.email,
        avatar: user.email[0].toUpperCase(), bio: '', status: 'online',
        createdAt: new Date().toISOString(), isOnline: true,
        lastSeen: new Date().toISOString()
      });
      snap = await get(ref(db, `users/${user.uid}`));
    }
    currentUser = { uid: user.uid, ...snap.val() };
    await update(ref(db, `users/${user.uid}`), { isOnline: true, lastSeen: new Date().toISOString() });
    updateUserBar();
    document.getElementById('authSection').style.display = 'none';
    document.getElementById('mainApp').style.display = 'flex';
    await initGlobal();
    loadMessages();
    loadMembers();
  } else {
    currentUser = null;
    document.getElementById('authSection').style.display = 'flex';
    document.getElementById('mainApp').style.display = 'none';
  }
});

function updateUserBar() {
  document.getElementById('userBarAv').textContent = currentUser.avatar || 'U';
  document.getElementById('userBarName').textContent = currentUser.username;
}

// ‚îÄ‚îÄ GLOBAL INIT ‚îÄ‚îÄ
async function initGlobal() {
  const snap = await get(ref(db, 'servers/global'));
  if (!snap.exists()) {
    await set(ref(db, 'servers/global'), {
      name: 'Global Server', owner: 'system', createdAt: new Date().toISOString()
    });
    for (const ch of ['welcome', 'general']) {
      await set(ref(db, `servers/global/channels/${ch}`), { name: ch, createdBy: 'system', createdAt: new Date().toISOString() });
    }
  }
}

// ‚îÄ‚îÄ SERVER SELECT ‚îÄ‚îÄ
window.selectServer = function(serverId, el) {
  currentServer = serverId;
  currentDmUid = null;

  document.querySelectorAll('.rail-btn').forEach(b => b.classList.remove('active'));
  if (el) el.classList.add('active');

  const isDM = serverId === 'dms';
  document.getElementById('channelsSection').style.display = isDM ? 'none' : 'block';
  document.getElementById('dmsSection').style.display = isDM ? 'block' : 'none';
  document.getElementById('panelActions').style.display = isDM ? 'none' : 'flex';
  document.getElementById('panelServerName').textContent = isDM ? 'Direct Messages' : 'Global Server';
  document.getElementById('callBtn').style.display = 'none';

  if (isDM) {
    document.getElementById('topbarIcon').textContent = 'üí¨';
    document.getElementById('topbarName').textContent = 'Direct Messages';
    document.getElementById('messageInput').placeholder = 'Select a friend to start chatting...';
    document.getElementById('messageInput').disabled = true;
    showWelcomeCard('Direct Messages üí¨', 'Select a friend from the list to start chatting');
    loadFriends();
    loadFriendRequests();
  } else {
    document.getElementById('messageInput').disabled = false;
    selectChannel('welcome', document.getElementById('ch-welcome'));
  }
};

// ‚îÄ‚îÄ CHANNEL SELECT ‚îÄ‚îÄ
window.selectChannel = function(chId, el) {
  currentChannel = chId;
  currentDmUid = null;
  document.querySelectorAll('.channel-row').forEach(r => r.classList.remove('active'));
  if (el) el.classList.add('active');
  document.getElementById('topbarIcon').textContent = '#';
  document.getElementById('topbarName').textContent = chId;
  document.getElementById('callBtn').style.display = 'none';
  document.getElementById('messageInput').disabled = false;
  document.getElementById('messageInput').placeholder = `Message #${chId}`;
  loadMessages();
};

// ‚îÄ‚îÄ START DM ‚îÄ‚îÄ
window.startDM = function(friendUid, friendName, avatarChar) {
  currentServer = 'dms';
  currentDmUid = friendUid;

  document.querySelectorAll('.dm-item').forEach(i => i.classList.remove('active'));
  const el = document.getElementById(`dm-${friendUid}`);
  if (el) el.classList.add('active');

  document.getElementById('topbarIcon').textContent = 'üí¨';
  document.getElementById('topbarName').textContent = friendName;
  document.getElementById('callBtn').style.display = 'flex';
  document.getElementById('messageInput').disabled = false;
  document.getElementById('messageInput').placeholder = `Message ${friendName}...`;
  loadMessages();
};

// ‚îÄ‚îÄ LOAD MESSAGES ‚îÄ‚îÄ
function showWelcomeCard(title, sub) {
  document.getElementById('messagesFeed').innerHTML = `
    <div class="welcome-card">
      <h3>${title}</h3>
      <p>${sub}</p>
    </div>`;
}

function loadMessages() {
  const feed = document.getElementById('messagesFeed');

  // Clean old messages but keep welcome card
  while (feed.children.length > 1) feed.removeChild(feed.lastChild);

  if (msgListener) { off(msgListener._ref, 'child_added', msgListener._fn); msgListener = null; }

  let msgRef;
  if (currentServer === 'dms' && currentDmUid) {
    const dmId = [currentUser.uid, currentDmUid].sort().join('_');
    msgRef = ref(db, `dms/${dmId}/messages`);
  } else if (currentServer !== 'dms') {
    msgRef = ref(db, `servers/${currentServer}/channels/${currentChannel}/messages`);
  } else {
    return;
  }

  feed.innerHTML = ''; // clear completely

  const fn = snap => {
    const msg = snap.val();
    if (!msg) return;
    appendMessage(snap.key, msg);
  };

  onChildAdded(msgRef, fn);
  msgListener = { _ref: msgRef, _fn: fn };
}

function appendMessage(key, msg) {
  const feed = document.getElementById('messagesFeed');
  const isDM = currentServer === 'dms';

  const div = document.createElement('div');
  div.className = 'msg-group';
  div.id = `msg-${key}`;

  const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

  let content = '';
  if (msg.type === 'image' && msg.imageUrl) {
    content = `<div class="msg-text">${msg.text || ''}</div>
    <img src="${msg.imageUrl}" class="msg-image" onclick="viewImage('${msg.imageUrl}')" alt="image">`;
  } else {
    content = `<div class="msg-text ${msg.isSystem ? 'system' : ''}">${escapeHtml(msg.text || '')}</div>`;
  }

  const canDelete = msg.senderId === currentUser?.uid;
  const actionsHtml = canDelete ? `
    <div class="msg-actions">
      <button class="msg-action-btn" onclick="deleteMsg('${key}')" title="Delete">üóë</button>
    </div>` : '';

  div.innerHTML = `
    <div class="msg-avatar-wrap">
      <div class="msg-avatar">${msg.senderAvatar || '?'}</div>
    </div>
    <div class="msg-body">
      <div class="msg-meta">
        <span class="msg-sender ${isDM ? 'dm-sender' : ''}">${escapeHtml(msg.sender)}</span>
        <span class="msg-time">${time}</span>
        ${actionsHtml}
      </div>
      ${content}
    </div>`;

  feed.appendChild(div);
  feed.scrollTop = feed.scrollHeight;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.appendChild(document.createTextNode(text));
  return div.innerHTML;
}

// ‚îÄ‚îÄ SEND MESSAGE ‚îÄ‚îÄ
window.sendMessage = async function() {
  if (!currentUser) return;
  const input = document.getElementById('messageInput');
  const text = input.value.trim();
  if (!text && !selectedFile) return;

  try {
    let msgData = {
      text: text || (selectedFile ? 'üì∏ Image' : ''),
      sender: currentUser.username,
      senderId: currentUser.uid,
      senderAvatar: currentUser.avatar || currentUser.username[0].toUpperCase(),
      timestamp: new Date().toISOString(),
      type: 'text'
    };

    if (selectedFile) {
      const fileName = `${Date.now()}_${selectedFile.name}`;
      const imgRef = sRef(storage, `images/${fileName}`);
      await uploadBytes(imgRef, selectedFile);
      const url = await getDownloadURL(imgRef);
      msgData.imageUrl = url;
      msgData.imageName = fileName;
      msgData.type = 'image';
    }

    let msgRef;
    if (currentServer === 'dms' && currentDmUid) {
      const dmId = [currentUser.uid, currentDmUid].sort().join('_');
      msgRef = ref(db, `dms/${dmId}/messages`);
    } else {
      msgRef = ref(db, `servers/${currentServer}/channels/${currentChannel}/messages`);
    }

    await push(msgRef, msgData);
    input.value = '';
    input.style.height = 'auto';
    clearImagePreview();
  } catch(e) {
    toast('Failed to send: ' + e.message, 'error');
  }
};

window.handleKey = function(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
};

window.autoGrow = function(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 160) + 'px';
};

// ‚îÄ‚îÄ IMAGE HANDLING ‚îÄ‚îÄ
window.handleFileSelect = function(e) {
  const file = e.target.files[0];
  if (!file) return;
  if (!file.type.startsWith('image/')) { toast('Please select an image', 'error'); return; }
  if (file.size > 10 * 1024 * 1024) { toast('Max 10MB image size', 'error'); return; }
  selectedFile = file;
  const reader = new FileReader();
  reader.onload = e => {
    document.getElementById('imgPreviewImg').src = e.target.result;
    document.getElementById('imgPreviewStrip').style.display = 'block';
  };
  reader.readAsDataURL(file);
};

window.clearImagePreview = function() {
  selectedFile = null;
  document.getElementById('imgPreviewStrip').style.display = 'none';
  document.getElementById('imgPreviewImg').src = '';
  document.getElementById('fileInput').value = '';
};

window.viewImage = function(url) {
  document.getElementById('enlargedImg').src = url;
  openModal('imageModal');
};

// ‚îÄ‚îÄ DELETE MESSAGE ‚îÄ‚îÄ
window.deleteMsg = async function(key) {
  if (!confirm('Delete this message?')) return;
  try {
    let msgRef;
    if (currentServer === 'dms' && currentDmUid) {
      const dmId = [currentUser.uid, currentDmUid].sort().join('_');
      msgRef = ref(db, `dms/${dmId}/messages/${key}`);
    } else {
      msgRef = ref(db, `servers/${currentServer}/channels/${currentChannel}/messages/${key}`);
    }
    const snap = await get(msgRef);
    const msg = snap.val();
    if (msg?.imageName) {
      try { await deleteObject(sRef(storage, `images/${msg.imageName}`)); } catch {}
    }
    await remove(msgRef);
    document.getElementById(`msg-${key}`)?.remove();
  } catch(e) { toast('Failed to delete', 'error'); }
};

// ‚îÄ‚îÄ FRIENDS ‚îÄ‚îÄ
function loadFriends() {
  const container = document.getElementById('friendsList');
  if (friendsUnsub) { off(ref(db, `friends/${currentUser.uid}`)); friendsUnsub = null; }

  onValue(ref(db, `friends/${currentUser.uid}`), async snap => {
    container.innerHTML = '';
    const data = snap.val();
    if (!data || Object.keys(data).length === 0) {
      container.innerHTML = `<div style="color:var(--text-muted);font-size:.8rem;padding:.5rem;">No friends yet. Add some! üëã</div>`;
      return;
    }
    const promises = Object.keys(data).map(async fid => {
      const usnap = await get(ref(db, `users/${fid}`));
      const ud = usnap.val();
      if (!ud) return;
      const el = document.createElement('div');
      el.className = 'dm-item';
      el.id = `dm-${fid}`;
      if (currentDmUid === fid) el.classList.add('active');
      el.innerHTML = `
        <div class="dm-avatar">
          ${ud.avatar || ud.username[0].toUpperCase()}
          <div class="status-dot ${ud.isOnline ? 'online' : 'offline'}"></div>
        </div>
        <div class="dm-info">
          <div class="dm-name">${escapeHtml(ud.username)}</div>
          <div class="dm-status-text">${ud.isOnline ? 'Online' : 'Offline'}</div>
        </div>
        <button class="dm-close-btn" onclick="event.stopPropagation(); removeFriend('${fid}','${escapeHtml(ud.username)}')" title="Remove">‚úï</button>`;
      el.addEventListener('click', () => startDM(fid, ud.username, ud.avatar || ud.username[0].toUpperCase()));
      container.appendChild(el);
    });
    await Promise.all(promises);
  });
  friendsUnsub = true;
}

function loadFriendRequests() {
  const container = document.getElementById('friendRequestsList');
  const badge = document.getElementById('reqBadge');
  if (reqsUnsub) { off(ref(db, `friendRequests/${currentUser.uid}`)); reqsUnsub = null; }

  onValue(ref(db, `friendRequests/${currentUser.uid}`), async snap => {
    container.innerHTML = '';
    const data = snap.val();
    if (!data) { badge.style.display = 'none'; return; }
    const pending = Object.entries(data).filter(([,v]) => v.status === 'pending');
    if (pending.length === 0) { badge.style.display = 'none'; return; }
    badge.textContent = pending.length;
    badge.style.display = 'flex';

    const promises = pending.map(async ([rid]) => {
      const usnap = await get(ref(db, `users/${rid}`));
      const ud = usnap.val();
      if (!ud) return;
      const el = document.createElement('div');
      el.className = 'friend-req-card';
      el.innerHTML = `
        <div class="dm-avatar" style="width:32px;height:32px;">${ud.avatar || ud.username[0].toUpperCase()}</div>
        <div class="freq-info">
          <div class="freq-name">${escapeHtml(ud.username)}</div>
          <div class="freq-sub">Sent you a friend request</div>
        </div>
        <div class="freq-btns">
          <button class="freq-btn accept" onclick="acceptReq('${rid}')">‚úì</button>
          <button class="freq-btn reject" onclick="rejectReq('${rid}')">‚úï</button>
        </div>`;
      container.appendChild(el);
    });
    await Promise.all(promises);
  });
  reqsUnsub = true;
}

window.sendFriendRequest = async function() {
  const username = document.getElementById('friendUsernameInput').value.trim();
  if (!username) return toast('Enter a username', 'error');
  if (username.toLowerCase() === currentUser.username.toLowerCase()) return toast('You cannot add yourself!', 'error');
  try {
    const usnap = await get(ref(db, `usernames/${username.toLowerCase()}`));
    if (!usnap.exists()) return toast('User not found', 'error');
    const fid = usnap.val();
    const alreadyFriend = await get(ref(db, `friends/${currentUser.uid}/${fid}`));
    if (alreadyFriend.exists()) return toast('Already friends!', 'error');
    const existingReq = await get(ref(db, `friendRequests/${fid}/${currentUser.uid}`));
    if (existingReq.exists() && existingReq.val().status === 'pending') return toast('Request already sent', 'error');
    await set(ref(db, `friendRequests/${fid}/${currentUser.uid}`), {
      from: currentUser.uid, fromUsername: currentUser.username,
      timestamp: new Date().toISOString(), status: 'pending'
    });
    closeModal('addFriendModal');
    document.getElementById('friendUsernameInput').value = '';
    toast(`Request sent to ${username}! ‚úì`, 'success');
  } catch(e) { toast(e.message, 'error'); }
};

window.acceptReq = async function(rid) {
  try {
    const usnap = await get(ref(db, `users/${rid}`));
    const ud = usnap.val();
    if (!ud) return;
    const ts = new Date().toISOString();
    await set(ref(db, `friends/${currentUser.uid}/${rid}`), { since: ts, username: ud.username });
    await set(ref(db, `friends/${rid}/${currentUser.uid}`), { since: ts, username: currentUser.username });
    await update(ref(db, `friendRequests/${currentUser.uid}/${rid}`), { status: 'accepted' });
    const dmId = [currentUser.uid, rid].sort().join('_');
    await set(ref(db, `dms/${dmId}`), { participants: [currentUser.uid, rid], createdAt: ts });
    await push(ref(db, `dms/${dmId}/messages`), {
      text: `üëã You are now friends! Say hello!`,
      sender: 'System', senderId: 'system', senderAvatar: 'ü§ñ',
      timestamp: ts, isSystem: true
    });
    toast(`You and ${ud.username} are now friends! üéâ`, 'success');
  } catch(e) { toast(e.message, 'error'); }
};

window.rejectReq = async function(rid) {
  await remove(ref(db, `friendRequests/${currentUser.uid}/${rid}`));
  toast('Request rejected', 'info');
};

window.removeFriend = async function(fid, name) {
  if (!confirm(`Remove ${name} from friends?`)) return;
  await remove(ref(db, `friends/${currentUser.uid}/${fid}`));
  await remove(ref(db, `friends/${fid}/${currentUser.uid}`));
  if (currentDmUid === fid) {
    currentDmUid = null;
    document.getElementById('topbarName').textContent = 'Direct Messages';
    document.getElementById('callBtn').style.display = 'none';
    document.getElementById('messageInput').disabled = true;
    showWelcomeCard('Direct Messages üí¨', 'Select a friend to start chatting');
  }
  toast(`${name} removed from friends`, 'info');
};

// ‚îÄ‚îÄ MEMBERS ‚îÄ‚îÄ
function loadMembers() {
  const list = document.getElementById('membersList');
  onValue(ref(db, 'users'), snap => {
    list.innerHTML = '';
    const users = snap.val();
    if (!users) return;
    // Self first
    const selfEl = createMemberEl(currentUser.uid, currentUser);
    list.appendChild(selfEl);
    Object.entries(users).forEach(([uid, u]) => {
      if (uid === currentUser.uid) return;
      list.appendChild(createMemberEl(uid, u));
    });
  });
}

function createMemberEl(uid, u) {
  const el = document.createElement('div');
  el.className = 'member-row';
  el.innerHTML = `
    <div class="member-av">
      ${u.avatar || '?'}
      <div class="status-dot ${u.isOnline ? 'online' : 'offline'}" style="position:absolute;bottom:-1px;right:-1px;border-color:var(--bg-deep);"></div>
    </div>
    <div class="member-name">${escapeHtml(u.username)}</div>`;
  return el;
}

// ‚îÄ‚îÄ SERVERS ‚îÄ‚îÄ
window.createServer = async function() {
  const name = document.getElementById('serverNameInput').value.trim();
  if (!name) return toast('Enter a server name', 'error');
  try {
    const sid = 'srv_' + Date.now();
    await set(ref(db, `servers/${sid}`), {
      name, owner: currentUser.uid, createdAt: new Date().toISOString()
    });
    for (const ch of ['welcome', 'general']) {
      await set(ref(db, `servers/${sid}/channels/${ch}`), { name: ch, createdBy: currentUser.uid, createdAt: new Date().toISOString() });
    }
    // Add to rail
    const btn = document.createElement('div');
    btn.className = 'rail-btn';
    btn.innerHTML = `${name[0].toUpperCase()}<span class="rail-tooltip">${escapeHtml(name)}</span>`;
    btn.onclick = () => { currentServer = sid; selectChannel('welcome', null); };
    document.getElementById('addServerBtn').before(btn);
    closeModal('createServerModal');
    document.getElementById('serverNameInput').value = '';
    toast(`Server "${name}" created!`, 'success');
  } catch(e) { toast(e.message, 'error'); }
};

window.createChannel = async function() {
  const name = document.getElementById('channelNameInput').value.trim().toLowerCase().replace(/\s+/g, '-');
  if (!name) return toast('Enter a channel name', 'error');
  try {
    await set(ref(db, `servers/${currentServer}/channels/${name}`), {
      name, createdBy: currentUser.uid, createdAt: new Date().toISOString()
    });
    const li = document.createElement('li');
    li.className = 'channel-row';
    li.id = `ch-${name}`;
    li.innerHTML = `<span class="ch-icon">#</span> ${name}`;
    li.onclick = () => selectChannel(name, li);
    document.getElementById('channelsList').appendChild(li);
    closeModal('createChannelModal');
    document.getElementById('channelNameInput').value = '';
    toast(`Channel #${name} created!`, 'success');
  } catch(e) { toast(e.message, 'error'); }
};

// ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ
// Register the profile loader (has access to module-scoped currentUser and db/ref/get)
window._openModalProfile = async function() {
  if (!currentUser) return;
  document.getElementById('profileAv').textContent = currentUser.avatar || 'U';
  document.getElementById('profileName').textContent = currentUser.username;
  document.getElementById('profileEmail').textContent = currentUser.email;
  document.getElementById('profileBio').textContent = currentUser.bio || 'No bio yet.';
  document.getElementById('profileSince').textContent = new Date(currentUser.createdAt).getFullYear();
  try {
    const fsnap = await get(ref(db, `friends/${currentUser.uid}`));
    document.getElementById('profileFriends').textContent = fsnap.exists() ? Object.keys(fsnap.val()).length : 0;
  } catch(e) { document.getElementById('profileFriends').textContent = '0'; }
};

window.openEditProfile = function() {
  document.getElementById('editUsername').value = currentUser.username;
  document.getElementById('editBio').value = currentUser.bio || '';
  document.getElementById('editStatus').value = currentUser.status || 'online';
  closeModal('profileModal');
  document.getElementById('editProfileModal').style.display = 'flex';
};

window.saveProfile = async function() {
  const newUsername = document.getElementById('editUsername').value.trim();
  const newBio = document.getElementById('editBio').value.trim();
  const newStatus = document.getElementById('editStatus').value;
  if (!newUsername) return toast('Username cannot be empty', 'error');
  try {
    const updates = { username: newUsername, bio: newBio, status: newStatus, avatar: newUsername[0].toUpperCase() };
    await update(ref(db, `users/${currentUser.uid}`), updates);
    currentUser = { ...currentUser, ...updates };
    updateUserBar();
    closeModal('editProfileModal');
    toast('Profile updated! ‚úì', 'success');
  } catch(e) { toast(e.message, 'error'); }
};

// ‚îÄ‚îÄ CALL ‚îÄ‚îÄ
window.startCall = async function() {
  if (!currentDmUid) return toast('Select a friend to call', 'error');
  const fsnap = await get(ref(db, `users/${currentDmUid}`));
  const fd = fsnap.val();
  document.getElementById('callTitle').textContent = `üìû Calling ${fd?.username || 'Friend'}...`;
  document.getElementById('callOverlay').style.display = 'block';
  try {
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    document.getElementById('localVideo').srcObject = localStream;
    toast('Call started! (Demo mode - WebRTC)', 'success');
    setTimeout(() => {
      document.getElementById('callTitle').textContent = `üìû In call with ${fd?.username || 'Friend'}`;
    }, 2000);
  } catch(e) {
    toast('Camera/mic permission denied', 'error');
    endCall();
  }
};

window.endCall = function() {
  if (peerConn) { peerConn.close(); peerConn = null; }
  if (localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
  document.getElementById('callOverlay').style.display = 'none';
  document.getElementById('localVideo').srcObject = null;
  document.getElementById('remoteVideo').srcObject = null;
  isMuted = false;
};

window.toggleMute = function() {
  if (!localStream) return;
  isMuted = !isMuted;
  localStream.getAudioTracks().forEach(t => t.enabled = !isMuted);
  const btn = document.getElementById('muteBtn');
  btn.textContent = isMuted ? 'üîá' : 'üé§';
  btn.classList.toggle('muted', isMuted);
};

// ‚îÄ‚îÄ MISC ‚îÄ‚îÄ
window.showInvite = function() {
  toast(`Invite link: partexchat.com/invite/${currentServer}`, 'info');
};
</script>
</body>
</html>
